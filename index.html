<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo - Reporte Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2 { text-align: center; margin-bottom: 20px; color: #1a1a1a; }

        /* CONTENEDOR PRINCIPAL */
        .contenedor-maestro {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* COLUMNAS */
        .columna-control, .columna-villa, .columna-tabla, .columna-derecha {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* ANCHOS */
        .columna-control { width: 260px; }
        .columna-villa { width: 160px; align-items: center; }
        .columna-tabla { width: 280px; }
        .columna-derecha { width: 260px; }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .contenedor-maestro { flex-direction: column; align-items: center; }
            .columna-control, .columna-villa, .columna-tabla, .columna-derecha {
                width: 90%; max-width: 400px;
            }
        }

        /* --- COMPONENTES UI --- */
        .panel-gris {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            border-radius: 6px;
            display: flex; flex-direction: column;
        }
        
        .panel-config {
            background-color: #fff;
            border: 2px dashed #adb5bd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex; flex-direction: column; gap: 8px;
        }

        .panel-contador {
            background-color: #e8f4fd;
            border: 1px solid #b6d4fe;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            margin-top: 10px;
        }
        .numero-contador { font-size: 36px; font-weight: bold; color: #0d6efd; margin-top: 0; line-height: 1;}

        .label-input { font-size: 13px; font-weight: bold; margin-bottom: 4px; }
        .label-small { font-size: 11px; font-weight: bold; color: #666; }
        .input-config { padding: 4px; border: 1px solid #ccc; text-align: center; width: 100%; border-radius: 4px; font-size: 12px;}

        #input-limite {
            width: 100%; padding: 6px; border: 2px solid #0d6efd;
            text-align: center; margin-bottom: 8px; font-weight: bold; font-size: 16px; border-radius: 4px;
        }

        .textarea-lista {
            width: 100%; height: 120px; box-sizing: border-box;
            border: 1px solid #ccc; padding: 8px; resize: none;
            font-family: monospace; font-size: 12px; border-radius: 4px;
        }

        .status-text {
            color: #dc3545; font-weight: bold; text-align: center; margin: 8px 0; font-size: 13px;
        }

        /* BOTONES */
        button { cursor: pointer; border-radius: 4px; border: none; font-weight: bold; transition: 0.2s; }
        .btn-azul { background-color: #0d6efd; color: white; padding: 10px; width: 100%; font-size: 13px; margin-bottom: 5px; }
        .btn-azul:hover:not(:disabled) { background-color: #0b5ed7; }
        .btn-azul:disabled { background-color: #a4c5f5; cursor: not-allowed; }
        
        .btn-gris-oscuro { background-color: #495057; color: white; padding: 6px; font-size: 11px; width: 100%; }
        
        .btn-rojo { background-color: #dc3545; color: white; padding: 8px; font-size: 12px; width: 100%; }
        .btn-rojo:hover { background-color: #bb2d3b; }
        
        .btn-whatsapp {
            background-color: #198754; color: white; padding: 12px; font-size: 14px; width: 100%;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-whatsapp:hover { background-color: #157347; }

        /* VISOR */
        .visor-animacion {
            border: 2px solid #0d6efd; background-color: #fff; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: bold; color: #198754; width: 100%;
            border-radius: 6px; margin-top: 5px;
        }

        /* TABLAS Y LISTAS EN PANTALLA */
        .titulo-lista { font-weight: bold; margin-bottom: 10px; text-align: center; color: #495057; }
        
        #lista-villa { list-style: none; padding: 0; margin: 0; width: 100%; }
        #lista-villa li {
            padding: 6px; border-bottom: 1px dashed #dee2e6; font-size: 13px;
            display: flex; justify-content: space-between;
        }
        .hora-villa { font-weight: bold; color: #6c757d; }
        
        /* SCROLL EN PANTALLA */
        .scroll-tabla {
            max-height: 500px; 
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .header-tabla {
            text-align: center; font-weight: bold; border-bottom: 2px solid #000;
            padding: 8px; background: #fff; border: 1px solid #333; border-bottom: none;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td {
            border: 1px solid #333; padding: 3px; text-align: center; height: 22px; font-weight: bold;
        }
        
        .txt-azul { color: #0d6efd; font-weight: bold; }
        .txt-rojo { color: #dc3545; font-weight: bold; }
        .celda-normal { background-color: #fff; color: #000; }
        .celda-bloqueada { background-color: #198754; color: transparent; }

        .panel-derecho { height: 100%; min-height: 400px; justify-content: space-between; }

        /* =========================================
           DISE√ëO DE LA "HOJA DE IMPRESI√ìN/CAPTURA"
           (Oculto en pantalla normal, visible para html2canvas)
           ========================================= */
        #hoja-captura-oculta {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 800px; /* Ancho fijo para buena resoluci√≥n */
            background-color: white;
            padding: 20px;
            border: 2px solid #333;
        }

        /* Estructura del reporte */
        .reporte-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .reporte-titulo {
            font-size: 24px; font-weight: bold; margin: 0 0 10px 0; text-transform: uppercase;
        }
        .reporte-info-grid {
            display: flex; justify-content: space-around; background-color: #f8f9fa; padding: 10px; border: 1px solid #ddd;
        }
        .reporte-dato {
            font-size: 16px; font-weight: bold;
        }
        .reporte-dato span { color: #0d6efd; }

        .reporte-cuerpo {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* Columna Izquierda Reporte (VILLA) */
        .reporte-col-villa {
            width: 35%;
            border: 1px solid #333;
        }
        .reporte-subtitulo {
            background-color: #333; color: white; text-align: center; padding: 5px; font-weight: bold;
        }
        #lista-villa-reporte {
            list-style: none; padding: 0; margin: 0;
        }
        #lista-villa-reporte li {
            padding: 5px 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 14px;
        }

        /* Columna Derecha Reporte (TABLA D) */
        .reporte-col-rutad {
            width: 65%;
        }
        /* La tabla en el reporte no tiene scroll, se ve entera */
        #tabla-rutad-reporte {
            width: 100%; border-collapse: collapse;
        }
        #tabla-rutad-reporte td {
            border: 1px solid #000; padding: 4px; text-align: center; font-weight: bold; font-size: 14px;
        }

        /* Footer Multa */
        .reporte-footer {
            margin-top: 20px;
            border: 2px solid #dc3545;
            background-color: #fff5f5;
            padding: 15px;
            text-align: center;
        }
        .texto-multa {
            color: #dc3545; font-size: 18px; font-weight: bold; text-transform: uppercase; margin: 0;
        }

    </style>
</head>
<body>

    <h2>Programa de Sorteo (Gesti√≥n de Salidas)</h2>

    <div class="contenedor-maestro">

        <div class="columna-control">
            <div class="panel-gris">
                <div class="label-input">CANTIDAD A SORTEAR:</div>
                <input type="number" id="input-limite" value="5" min="1">
                
                <textarea id="lista-izq" class="textarea-lista">E 45
E 56
E 33
E 11
E 21
E 60
E 70
E 80
E 90
E 100
E 110
E 120</textarea>
                
                <div id="status-izq" class="status-text">LISTO</div>
                
                <button id="btn-iniciar" class="btn-azul" onclick="iniciarSecuenciaCompleta()">SORTEAR 1 (VILLA)</button>
                <button id="btn-reset" class="btn-rojo" onclick="resetearTodo()">RESETEAR SISTEMA</button>
            </div>

            <div class="visor-animacion" id="visor-izq"></div>
            
            <div class="panel-config">
                <div style="text-align: center; font-weight: bold; font-size: 12px; margin-bottom: 5px; text-decoration: underline;">CONFIGURACI√ìN SALIDAS</div>
                
                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                    <div style="flex: 1;">
                        <div class="label-small">VILLA INICIO:</div>
                        <input type="time" id="input-hora-inicio" class="input-config" value="05:48">
                    </div>
                    <div style="flex: 1;">
                        <div class="label-small">FREC VILLA (m):</div>
                        <input type="number" id="input-minutos" class="input-config" value="14" min="1">
                    </div>
                </div>
                <button class="btn-gris-oscuro" onclick="generarNuevoHorarioVilla()">APLICAR H. VILLA</button>
                <div id="msg-horario" style="font-size: 10px; color: green; text-align: center; height: 12px;"></div>

                <hr style="width: 100%; border: 0; border-top: 1px dashed #ccc; margin: 5px 0;">

                <div style="display: flex; gap: 5px; align-items: center;">
                    <div style="flex: 2;">
                        <div class="label-small">FREC. RUTA D (min):</div>
                        <input type="number" id="input-frec-d" class="input-config" value="10" placeholder="Ej: 10">
                    </div>
                </div>
            </div>

            <div class="panel-contador">
                <div style="font-weight: bold; font-size: 12px; text-transform: uppercase;">Unidades Sorteados</div>
                <div id="contador-global" class="numero-contador">0</div>
            </div>
        </div>

        <div class="columna-villa">
            <div class="titulo-lista">VILLA</div>
            <ul id="lista-villa"></ul>
        </div>

        <div class="columna-tabla">
            <button class="btn-whatsapp" onclick="generarReporteImagen()">
                üì∏ DESCARGAR REPORTE
            </button>
            
            <div class="header-tabla">RUTA D</div>
            <div class="scroll-tabla">
                <table id="tabla-rutad">
                    <tbody id="body-tabla">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="columna-derecha">
            <div class="panel-gris panel-derecho">
                <div>
                    <div class="label-input">SORTEO PRINCIPAL (RUTA D)</div>
                    <textarea id="lista-der" class="textarea-lista" style="height: 250px;" placeholder="Excedentes aqu√≠..."></textarea>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <div id="status-der" class="status-text" style="font-size: 12px;">EN ESPERA...</div>
                    <div class="visor-animacion" id="visor-der"></div>
                </div>
            </div>
        </div>
    </div>


    <div id="hoja-captura-oculta">
        <div class="reporte-header">
            <h1 class="reporte-titulo">PROGRAMACI√ìN DE SALIDAS</h1>
            <div class="reporte-info-grid">
                <div class="reporte-dato">Frec. VILLA: <span id="rep-frec-villa">--</span> min</div>
                <div class="reporte-dato">Frec. RUTA D: <span id="rep-frec-d">--</span> min</div>
                <div class="reporte-dato">Total Unidades: <span id="rep-total">0</span></div>
            </div>
        </div>

        <div class="reporte-cuerpo">
            <div class="reporte-col-villa">
                <div class="reporte-subtitulo">SALIDAS VILLA</div>
                <ul id="lista-villa-reporte">
                    </ul>
            </div>

            <div class="reporte-col-rutad">
                <div class="reporte-subtitulo">SALIDAS RUTA D</div>
                <table id="tabla-rutad-reporte">
                    <tbody id="body-tabla-reporte">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="reporte-footer">
            <p class="texto-multa">‚ö†Ô∏è UNIDAD QUE NO SALGA SER√Å MULTADO CON 30 SOLES SIN DERECHO A RECLAMO</p>
        </div>
    </div>


    <script>
        // --- 1. DEFINICI√ìN DEL HORARIO MAESTRO ---
        const HORARIO_BASE = [
            {t:'VILLA', h:'5:25'}, {t:'D', h:'5:35'},
            {t:'VILLA', h:'5:45'}, {t:'D', h:'5:55'},
            {t:'VILLA', h:'6:05'}, {t:'D', h:'6:15'},
            {t:'VILLA', h:'6:25'}, {t:'D', h:'6:35'},
            {t:'VILLA', h:'6:45'}, {t:'D', h:'6:55'},
            {t:'VILLA', h:'7:05'}, {t:'D', h:'7:15'},
            // BLOQUEO DINAMICO A PARTIR DE 7:25
            {t:'VILLA', h:'7:25'}, {t:'D', h:'7:35'},
            {t:'VILLA', h:'7:45'}, {t:'D', h:'7:55'},
            {t:'VILLA', h:'8:05'}, {t:'D', h:'8:15'},
            {t:'VILLA', h:'8:25'}, {t:'D', h:'8:35'},
            {t:'VILLA', h:'8:45'}, {t:'D', h:'8:55'},
            {t:'VILLA', h:'9:05'}, {t:'D', h:'9:15'},
            {t:'VILLA', h:'9:25'}, {t:'D', h:'9:35'},
            {t:'VILLA', h:'9:45'}, {t:'D', h:'9:55'},
            {t:'VILLA', h:'10:05'},{t:'D', h:'10:15'},
            {t:'VILLA', h:'10:25'},{t:'D', h:'10:35'}
        ];
        
        let horarioEstado = JSON.parse(JSON.stringify(HORARIO_BASE));

        let horasVillaActuales = [
            "5:48", "6:02", "6:16", "6:30", "6:44",
            "7:00", "7:14", "7:28", "7:42", "7:56",
            "8:10", "8:24", "8:38", "8:52", "9:06"
        ];

        // --- REFERENCIAS ---
        const listaIzq = document.getElementById('lista-izq');
        const listaDer = document.getElementById('lista-der');
        const ulVilla = document.getElementById('lista-villa');
        const bodyTabla = document.getElementById('body-tabla');
        const btnIniciar = document.getElementById('btn-iniciar');
        const btnReset = document.getElementById('btn-reset');
        const visorIzq = document.getElementById('visor-izq');
        const visorDer = document.getElementById('visor-der');
        const statusIzq = document.getElementById('status-izq');
        const statusDer = document.getElementById('status-der');
        const inputLimite = document.getElementById('input-limite');
        const inputHoraInicio = document.getElementById('input-hora-inicio');
        const inputMinutos = document.getElementById('input-minutos');
        const inputFrecD = document.getElementById('input-frec-d');
        const msgHorario = document.getElementById('msg-horario');
        const contadorGlobalEl = document.getElementById('contador-global');

        // Estado
        let indexTabla = 0;
        let indexVilla = 0;
        let backupListaIzq = "";
        let backupListaDer = "";
        let enCurso = false;
        let contadorTotalSorteados = 0;

        // --- 2. GENERAR TABLA PANTALLA ---
        function initTabla() {
            let html = '';
            horarioEstado.forEach((item, i) => {
                const claseTexto = item.t === 'VILLA' ? 'txt-azul' : 'txt-rojo';
                const claseCelda = item.lock ? 'celda-bloqueada' : 'celda-normal';
                
                html += `<tr>
                    <td class="${claseTexto}">${item.t}</td>
                    <td class="${claseTexto}">${item.h}</td>
                    <td id="celda-${i}" class="${claseCelda}"></td>
                </tr>`;
            });
            bodyTabla.innerHTML = html;
        }
        initTabla();

        // --- 3. BLOQUEO DIN√ÅMICO ---
        function aplicarBloqueosPorCantidad() {
            const cantidad = parseInt(inputLimite.value) || 0;
            horarioEstado = JSON.parse(JSON.stringify(HORARIO_BASE));
            
            let startIndex = -1;
            for(let i=0; i<horarioEstado.length; i++) {
                if (horarioEstado[i].h === '7:25' && horarioEstado[i].t === 'VILLA') {
                    startIndex = i; break;
                }
            }

            if (startIndex !== -1 && cantidad > 0) {
                let bloqueadosCount = 0;
                for (let i = startIndex; i < horarioEstado.length; i++) {
                    if (horarioEstado[i].t === 'VILLA') {
                        if (bloqueadosCount < cantidad) {
                            horarioEstado[i].lock = true; 
                            bloqueadosCount++;
                        }
                    }
                }
            }
            initTabla();
        }

        // --- 4. CONFIG HORARIO ---
        function generarNuevoHorarioVilla() {
            const inicioStr = inputHoraInicio.value; 
            const intervalo = parseInt(inputMinutos.value);
            if (!inicioStr || isNaN(intervalo)) { alert("Inv√°lido."); return; }

            const [horas, minutos] = inicioStr.split(':').map(Number);
            let fechaBase = new Date();
            fechaBase.setHours(horas, minutos, 0, 0);

            let nuevasHoras = [];
            for (let i = 0; i < 30; i++) {
                let h = fechaBase.getHours().toString();
                if (fechaBase.getHours() < 10) h = h; else h = h.padStart(2, '0');
                let m = fechaBase.getMinutes().toString().padStart(2, '0');
                nuevasHoras.push(`${h}:${m}`);
                fechaBase.setMinutes(fechaBase.getMinutes() + intervalo);
            }
            horasVillaActuales = nuevasHoras;
            msgHorario.textContent = "¬°Actualizado!";
            setTimeout(() => msgHorario.textContent = "", 2000);
        }

        // --- 5. RESETEO ---
        function resetearTodo() {
            if (enCurso) { if(!confirm("¬øReiniciar?")) return; location.reload(); return; }
            if (backupListaIzq) listaIzq.value = backupListaIzq;
            if (backupListaDer) listaDer.value = backupListaDer;

            ulVilla.innerHTML = ''; visorIzq.textContent = ""; visorDer.textContent = "";
            indexTabla = 0; indexVilla = 0; contadorTotalSorteados = 0;
            contadorGlobalEl.textContent = "0";

            aplicarBloqueosPorCantidad(); 
            statusIzq.textContent = "LISTO"; statusDer.textContent = "EN ESPERA...";
            btnIniciar.disabled = false;
        }

        // --- 6. SECUENCIA MAESTRA ---
        async function iniciarSecuenciaCompleta() {
            const raw = listaIzq.value.trim().split('\n').filter(x => x.trim() !== '');
            const limite = parseInt(inputLimite.value) || 5;
            if (raw.length === 0) { alert("Lista vac√≠a"); return; }

            aplicarBloqueosPorCantidad();
            backupListaIzq = listaIzq.value;
            backupListaDer = listaDer.value;

            enCurso = true; btnIniciar.disabled = true; btnReset.disabled = true;

            let bolsaJuego = [...raw];
            let ganadores = [];
            ulVilla.innerHTML = ''; indexVilla = 0;

            // FASE 1: VILLA
            for (let i = 0; i < limite; i++) {
                if (bolsaJuego.length === 0) break;
                statusIzq.textContent = `Sorteando ${i+1}/${limite}...`;
                const ganador = await animarVisor(visorIzq, bolsaJuego);
                ganadores.push(ganador);
                
                contadorTotalSorteados++; contadorGlobalEl.textContent = contadorTotalSorteados;
                
                const li = document.createElement('li');
                const hora = horasVillaActuales[indexVilla] || "---";
                li.innerHTML = `<span class="hora-villa">${hora}</span> <span class="num-villa">${ganador}</span>`;
                ulVilla.appendChild(li);
                indexVilla++;
                
                const idx = bolsaJuego.indexOf(ganador);
                if (idx > -1) bolsaJuego.splice(idx, 1);
            }
            statusIzq.textContent = "¬°VILLA FINALIZADO!";
            
            let textoPrevio = listaDer.value.trim();
            let nuevos = bolsaJuego.join('\n');
            if (textoPrevio !== "") listaDer.value = textoPrevio + "\n" + nuevos;
            else listaDer.value = nuevos;
            listaIzq.value = ganadores.join('\n');

            // FASE 2: RUTA D
            statusDer.textContent = "Iniciando RUTA D...";
            await new Promise(r => setTimeout(r, 1000));

            let bolsaPrincipal = listaDer.value.trim().split('\n').filter(x => x.trim() !== '');
            if (bolsaPrincipal.length > 0) {
                while (bolsaPrincipal.length > 0 && indexTabla < horarioEstado.length) {
                    if (horarioEstado[indexTabla].lock === true) { indexTabla++; continue; }

                    const ganadorD = await animarVisor(visorDer, bolsaPrincipal);
                    contadorTotalSorteados++; contadorGlobalEl.textContent = contadorTotalSorteados;

                    const celda = document.getElementById(`celda-${indexTabla}`);
                    if (celda) celda.textContent = ganadorD;
                    indexTabla++; 
                    const idxD = bolsaPrincipal.indexOf(ganadorD);
                    if (idxD > -1) bolsaPrincipal.splice(idxD, 1);
                    listaDer.value = bolsaPrincipal.join('\n');
                }
                statusDer.textContent = (bolsaPrincipal.length > 0) ? "Tabla llena" : "¬°FINALIZADO!";
            } else { statusDer.textContent = "No hay excedentes."; }

            enCurso = false; btnReset.disabled = false;
        }

        function animarVisor(visor, lista) {
            return new Promise(resolve => {
                let contador = 0; const vueltas = 12; const intervalo = 40; 
                const timer = setInterval(() => {
                    const random = lista[Math.floor(Math.random() * lista.length)];
                    visor.textContent = random;
                    contador++;
                    if (contador >= vueltas) {
                        clearInterval(timer);
                        const final = lista[Math.floor(Math.random() * lista.length)];
                        visor.textContent = final; resolve(final);
                    }
                }, intervalo);
            });
        }

        // --- 7. GENERACI√ìN DEL REPORTE FINAL ---
        function generarReporteImagen() {
            // 1. Preparar datos en la Hoja Oculta
            const repFrecVilla = document.getElementById('rep-frec-villa');
            const repFrecD = document.getElementById('rep-frec-d');
            const repTotal = document.getElementById('rep-total');
            const listaVillaReporte = document.getElementById('lista-villa-reporte');
            const bodyTablaReporte = document.getElementById('body-tabla-reporte');

            // Llenar cabecera
            repFrecVilla.textContent = inputMinutos.value;
            repFrecD.textContent = inputFrecD.value || "--";
            repTotal.textContent = contadorTotalSorteados;

            // Clonar listas (copiar el HTML actual de lo visible a lo oculto)
            listaVillaReporte.innerHTML = ulVilla.innerHTML;
            bodyTablaReporte.innerHTML = bodyTabla.innerHTML;

            // 2. Tomar foto al div oculto #hoja-captura-oculta
            // html2canvas ignora el "top: -9999px" si le pasamos el elemento directo,
            // pero es mejor clonarlo temporalmente al body visible si da problemas.
            // Probemos directo:
            
            const elemento = document.getElementById('hoja-captura-oculta');

            // Truco: Para que html2canvas renderice bien algo oculto, a veces es mejor 
            // moverlo a una posici√≥n visible moment√°neamente o usar onclone.
            // Vamos a usar un enfoque seguro: Clonar y a√±adir al body con z-index alto.
            
            html2canvas(elemento, {
                scale: 2, // Alta calidad
                windowWidth: 1000,
                onclone: (clonedDoc) => {
                    // Asegurar que el clon sea visible en el render
                    const clon = clonedDoc.getElementById('hoja-captura-oculta');
                    clon.style.display = 'block';
                    clon.style.position = 'static';
                    clon.style.top = 'auto';
                    clon.style.left = 'auto';
                }
            }).then(canvas => {
                // Descargar
                const link = document.createElement('a');
                link.download = 'Reporte_Salidas.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            }).catch(err => {
                alert("Error generando reporte: " + err);
            });
        }

    </script>
</body>
</html>