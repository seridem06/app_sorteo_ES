<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Configurable - VILLA y RUTA D</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 20px;
            color: #000;
        }

        h2 { margin-top: 0; margin-bottom: 20px; }

        .contenedor-maestro {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        /* --- COLUMNA 1: CONTROLES VILLA --- */
        .columna-control {
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-gris {
            background-color: #dcdcdc;
            border: 2px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* PANEL CONFIGURACIÓN (NUEVO) */
        .panel-config {
            background-color: #f0f0f0;
            border: 2px dashed #555;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .label-input { font-size: 14px; font-weight: bold; margin-bottom: 2px; }
        .label-small { font-size: 12px; font-weight: bold; color: #555; }
        
        .input-config {
            padding: 3px;
            border: 1px solid #777;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        #input-limite {
            width: 50px;
            padding: 4px;
            border: 1px solid #777;
            text-align: center;
            margin-bottom: 8px;
        }

        .textarea-lista {
            width: 100%;
            height: 120px; /* Un poco menos alto para dar espacio a la config */
            box-sizing: border-box;
            border: 1px solid #777;
            padding: 5px;
            resize: none;
            font-family: monospace;
            font-size: 13px;
        }

        .status-text {
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
            font-size: 13px;
        }

        /* BOTONES */
        .btn-azul {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .btn-azul:disabled { background-color: #999; cursor: not-allowed; }
        
        .btn-gris-oscuro {
            background-color: #555;
            color: white;
            font-weight: bold;
            border: none;
            padding: 6px;
            cursor: pointer;
            font-size: 11px;
            width: 100%;
            border-radius: 3px;
        }
        .btn-gris-oscuro:hover { background-color: #333; }

        .btn-rojo {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            border-radius: 4px;
        }

        /* VISOR DE ANIMACIÓN */
        .visor-animacion {
            border: 2px solid #007bff;
            background-color: #fff;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #28a745;
            width: 180px;
            align-self: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* --- COLUMNA 2: RESULTADOS VILLA --- */
        .columna-villa {
            width: 140px;
            border: 2px solid #000;
            min-height: 480px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .titulo-lista { font-weight: bold; margin: 10px 0; text-align: center; }
        
        #lista-villa {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        #lista-villa li {
            padding: 5px 10px;
            border-bottom: 1px dashed #ccc;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }
        .hora-villa { font-weight: bold; color: #555; }
        .num-villa { font-weight: bold; color: #000; }

        /* --- COLUMNA 3: TABLA RUTA D (LÓGICA BLOQUEO) --- */
        .columna-tabla {
            width: 240px;
            border: 3px solid #000;
            background: #fff;
            max-height: 800px; 
            overflow-y: auto;
        }
        .header-tabla {
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #000;
            padding: 5px;
            background: #fff;
            position: sticky;
            top: 0;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td {
            border: 1px solid #000;
            padding: 2px 4px;
            text-align: center;
            height: 22px;
            font-weight: bold;
        }
        
        .txt-azul { color: #0056b3; font-weight: bold; }
        .txt-rojo { color: #d90000; font-weight: bold; }
        
        .celda-normal { background-color: #fff; color: #000; }
        .celda-bloqueada { 
            background-color: #00b050; 
            color: transparent; 
        }

        /* --- COLUMNA 4: SORTEO PRINCIPAL --- */
        .columna-derecha {
            width: 240px;
        }
        .panel-derecho {
            height: 480px;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <h2>Programa de Sorteo (Con Configuración de Horario)</h2>

    <div class="contenedor-maestro">

        <div class="columna-control">
            <div class="panel-gris">
                <div class="label-input">CANTIDAD a sortear (VILLA):</div>
                <input type="number" id="input-limite" value="5" min="1">
                
                <textarea id="lista-izq" class="textarea-lista">E 45
E 56
E 33
E 11
E 21
E 60
E 70
E 80
E 90
E 100
E 110
E 120</textarea>
                
                <div id="status-izq" class="status-text">LISTO: 5 a VILLA</div>
                
                <button id="btn-iniciar" class="btn-azul" onclick="iniciarSecuenciaCompleta()">SORTEAR 1 (VILLA)</button>
                <button id="btn-reset" class="btn-rojo" onclick="resetearTodo()">RESETEAR / RESTAURAR</button>
            </div>

            <div class="visor-animacion" id="visor-izq"></div>
            
            <div class="panel-config">
                <div style="text-align: center; font-weight: bold; font-size: 13px; margin-bottom: 5px;">CONFIGURAR HORARIO VILLA</div>
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <div class="label-small">INICIO:</div>
                        <input type="time" id="input-hora-inicio" class="input-config" value="05:48">
                    </div>
                    <div style="flex: 1;">
                        <div class="label-small">RANGO (min):</div>
                        <input type="number" id="input-minutos" class="input-config" value="14" min="1">
                    </div>
                </div>
                
                <button class="btn-gris-oscuro" onclick="generarNuevoHorarioVilla()">APLICAR NUEVO HORARIO</button>
                <div id="msg-horario" style="font-size: 10px; color: green; text-align: center; height: 12px;"></div>
            </div>

        </div>

        <div class="columna-villa">
            <div class="titulo-lista">VILLA</div>
            <ul id="lista-villa"></ul>
        </div>

        <div class="columna-tabla">
            <div class="header-tabla">RUTA D</div>
            <table id="tabla-rutad">
                <tbody id="body-tabla">
                    </tbody>
            </table>
        </div>

        <div class="columna-derecha">
            <div class="panel-gris panel-derecho">
                <div>
                    <div class="label-input">SORTEO PRINCIPAL (RUTA D)</div>
                    <textarea id="lista-der" class="textarea-lista" style="height: 220px;" placeholder="Excedentes aquí..."></textarea>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <div id="status-der" class="status-text" style="font-size: 12px;">EN ESPERA...</div>
                    <div class="visor-animacion" id="visor-der" style="width: 100%;"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DATOS INICIALES ---
        const HORARIO_MAESTRO = [
            {t:'VILLA', h:'5:25', lock: false}, {t:'D', h:'5:35', lock: false},
            {t:'VILLA', h:'5:45', lock: false}, {t:'D', h:'5:55', lock: false},
            {t:'VILLA', h:'6:05', lock: false}, {t:'D', h:'6:15', lock: false},
            {t:'VILLA', h:'6:25', lock: false}, {t:'D', h:'6:35', lock: false},
            {t:'VILLA', h:'6:45', lock: false}, {t:'D', h:'6:55', lock: false},
            {t:'VILLA', h:'7:05', lock: false}, {t:'D', h:'7:15', lock: false},
            // ZONA BLOQUEO
            {t:'VILLA', h:'7:25', lock: true}, {t:'D', h:'7:35', lock: false},
            {t:'VILLA', h:'7:45', lock: true}, {t:'D', h:'7:55', lock: false},
            {t:'VILLA', h:'8:05', lock: true}, {t:'D', h:'8:15', lock: false},
            {t:'VILLA', h:'8:25', lock: true}, {t:'D', h:'8:35', lock: false},
            {t:'VILLA', h:'8:45', lock: true}, {t:'D', h:'8:55', lock: false},
            {t:'VILLA', h:'9:05', lock: true},
            // RETORNO
            {t:'D', h:'9:15', lock: false},
            {t:'VILLA', h:'9:25', lock: false}, {t:'D', h:'9:35', lock: false},
            {t:'VILLA', h:'9:45', lock: false}, {t:'D', h:'9:55', lock: false},
            {t:'VILLA', h:'10:05', lock: false},{t:'D', h:'10:15', lock: false},
            {t:'VILLA', h:'10:25', lock: false},{t:'D', h:'10:35', lock: false}
        ];

        // Lista de horas Villa (Inicial por defecto)
        // Ahora es LET para poder cambiarla
        let horasVillaActuales = [
            "5:48", "6:02", "6:16", "6:30", "6:44",
            "7:00", "7:14", "7:28", "7:42", "7:56",
            "8:10", "8:24", "8:38", "8:52", "9:06"
        ];

        // --- REFERENCIAS ---
        const listaIzq = document.getElementById('lista-izq');
        const listaDer = document.getElementById('lista-der');
        const ulVilla = document.getElementById('lista-villa');
        const bodyTabla = document.getElementById('body-tabla');
        const btnIniciar = document.getElementById('btn-iniciar');
        const btnReset = document.getElementById('btn-reset');
        const visorIzq = document.getElementById('visor-izq');
        const visorDer = document.getElementById('visor-der');
        const statusIzq = document.getElementById('status-izq');
        const statusDer = document.getElementById('status-der');
        const inputLimite = document.getElementById('input-limite');
        
        // Config inputs
        const inputHoraInicio = document.getElementById('input-hora-inicio');
        const inputMinutos = document.getElementById('input-minutos');
        const msgHorario = document.getElementById('msg-horario');

        // Estado
        let indexTabla = 0;
        let indexVilla = 0;
        let backupListaIzq = "";
        let backupListaDer = "";
        let enCurso = false;

        // --- 2. GENERAR TABLA VISUAL ---
        function initTabla() {
            let html = '';
            HORARIO_MAESTRO.forEach((item, i) => {
                const claseTexto = item.t === 'VILLA' ? 'txt-azul' : 'txt-rojo';
                const claseCelda = item.lock ? 'celda-bloqueada' : 'celda-normal';
                
                html += `<tr>
                    <td class="${claseTexto}">${item.t}</td>
                    <td class="${claseTexto}">${item.h}</td>
                    <td id="celda-${i}" class="${claseCelda}"></td>
                </tr>`;
            });
            bodyTabla.innerHTML = html;
        }
        initTabla();

        // --- 3. LÓGICA DE HORARIO DINÁMICO ---
        function generarNuevoHorarioVilla() {
            const inicioStr = inputHoraInicio.value; // "HH:MM"
            const intervalo = parseInt(inputMinutos.value);

            if (!inicioStr || isNaN(intervalo)) {
                alert("Por favor ingrese una hora válida y minutos.");
                return;
            }

            // Parsear hora inicio
            const [horas, minutos] = inicioStr.split(':').map(Number);
            let fechaBase = new Date();
            fechaBase.setHours(horas, minutos, 0, 0);

            let nuevasHoras = [];
            // Generamos suficientes horas (ej. 30) para cubrir cualquier sorteo
            for (let i = 0; i < 30; i++) {
                // Formatear HH:MM
                let h = fechaBase.getHours().toString().padStart(2, '0'); // Quitar padStart si quieres "5:xx" en vez de "05:xx"
                // Para coincidir con tu estilo (5:44 sin cero delante si es <10), hacemos esto:
                if (fechaBase.getHours() < 10 && h.startsWith('0')) h = h.substring(1); 
                
                let m = fechaBase.getMinutes().toString().padStart(2, '0');
                nuevasHoras.push(`${h}:${m}`);

                // Sumar minutos
                fechaBase.setMinutes(fechaBase.getMinutes() + intervalo);
            }

            horasVillaActuales = nuevasHoras;
            
            msgHorario.textContent = "¡Horario actualizado!";
            setTimeout(() => { msgHorario.textContent = ""; }, 2000);
            
            // Si ya se reseteó la lista visual, limpiarla para evitar confusiones
            if (!enCurso && ulVilla.children.length === 0) {
                // Todo bien
            } else if (!enCurso && ulVilla.children.length > 0) {
                // Si había datos viejos, avisa que se aplicarán al reiniciar o siguiente sorteo
            }
        }


        // --- 4. RESETEO ---
        function resetearTodo() {
            if (enCurso) {
                if(!confirm("Sorteo en curso. ¿Reiniciar página?")) return;
                location.reload(); 
                return;
            }

            if (backupListaIzq) listaIzq.value = backupListaIzq;
            if (backupListaDer) listaDer.value = backupListaDer;

            ulVilla.innerHTML = '';
            initTabla();
            
            visorIzq.textContent = "";
            visorDer.textContent = "";

            indexTabla = 0;
            indexVilla = 0;

            statusIzq.textContent = "LISTO (RESETEADO)";
            statusDer.textContent = "EN ESPERA...";
            btnIniciar.disabled = false;
        }


        // --- 5. SECUENCIA AUTOMÁTICA ---
        async function iniciarSecuenciaCompleta() {
            const raw = listaIzq.value.trim().split('\n').filter(x => x.trim() !== '');
            const limite = parseInt(inputLimite.value) || 5;
            if (raw.length === 0) { alert("Lista vacía"); return; }

            backupListaIzq = listaIzq.value;
            backupListaDer = listaDer.value;

            enCurso = true;
            btnIniciar.disabled = true;
            btnReset.disabled = true;

            // --- FASE 1: SORTEO VILLA ---
            let bolsaJuego = [...raw];
            let ganadores = [];
            ulVilla.innerHTML = '';
            indexVilla = 0;

            for (let i = 0; i < limite; i++) {
                if (bolsaJuego.length === 0) break;
                statusIzq.textContent = `Sorteando ${i+1}/${limite}...`;
                
                const ganador = await animarVisor(visorIzq, bolsaJuego);
                ganadores.push(ganador);
                
                const li = document.createElement('li');
                // USAMOS EL ARRAY DINÁMICO
                const hora = horasVillaActuales[indexVilla] || "---";
                
                li.innerHTML = `<span class="hora-villa">${hora}</span> <span class="num-villa">${ganador}</span>`;
                ulVilla.appendChild(li);
                indexVilla++;
                
                const idx = bolsaJuego.indexOf(ganador);
                if (idx > -1) bolsaJuego.splice(idx, 1);
            }
            statusIzq.textContent = "¡VILLA FINALIZADO!";
            
            // Transferencia
            let textoPrevio = listaDer.value.trim();
            let nuevos = bolsaJuego.join('\n');
            if (textoPrevio !== "") listaDer.value = textoPrevio + "\n" + nuevos;
            else listaDer.value = nuevos;
            
            listaIzq.value = ganadores.join('\n');

            // --- FASE 2: RUTA D ---
            statusDer.textContent = "Iniciando RUTA D...";
            await new Promise(r => setTimeout(r, 1000));

            let bolsaPrincipal = listaDer.value.trim().split('\n').filter(x => x.trim() !== '');
            
            if (bolsaPrincipal.length > 0) {
                while (bolsaPrincipal.length > 0 && indexTabla < HORARIO_MAESTRO.length) {
                    
                    if (HORARIO_MAESTRO[indexTabla].lock === true) {
                        indexTabla++;
                        continue; 
                    }

                    const ganadorD = await animarVisor(visorDer, bolsaPrincipal);

                    const celda = document.getElementById(`celda-${indexTabla}`);
                    if (celda) celda.textContent = ganadorD;
                    indexTabla++; 

                    const idxD = bolsaPrincipal.indexOf(ganadorD);
                    if (idxD > -1) bolsaPrincipal.splice(idxD, 1);
                    listaDer.value = bolsaPrincipal.join('\n');
                }
                
                if (bolsaPrincipal.length > 0) statusDer.textContent = "Tabla llena (sobran números)";
                else statusDer.textContent = "¡FINALIZADO!";
            } else {
                statusDer.textContent = "No hay excedentes.";
            }

            enCurso = false;
            btnReset.disabled = false;
        }

        // --- ANIMACIÓN ---
        function animarVisor(visor, lista) {
            return new Promise(resolve => {
                let contador = 0;
                const vueltas = 15;
                const intervalo = 40; 
                const timer = setInterval(() => {
                    const random = lista[Math.floor(Math.random() * lista.length)];
                    visor.textContent = random;
                    contador++;
                    if (contador >= vueltas) {
                        clearInterval(timer);
                        const final = lista[Math.floor(Math.random() * lista.length)];
                        visor.textContent = final;
                        resolve(final);
                    }
                }, intervalo);
            });
        }
    </script>
</body>
</html>