<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo Inteligente - Bloqueo Dinámico</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 20px;
            color: #000;
        }

        h2 { margin-top: 0; margin-bottom: 20px; }

        .contenedor-maestro {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        /* --- COLUMNA 1: CONTROLES VILLA --- */
        .columna-control {
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-gris {
            background-color: #dcdcdc;
            border: 2px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        
        /* PANEL CONFIGURACIÓN */
        .panel-config {
            background-color: #f0f0f0;
            border: 2px dashed #555;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
        }

        .label-small { font-size: 11px; font-weight: bold; color: #555; }
        .input-config {
            padding: 3px;
            border: 1px solid #777;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            font-size: 12px;
        }

        .label-input { font-size: 14px; font-weight: bold; margin-bottom: 5px; }

        #input-limite {
            width: 50px;
            padding: 4px;
            border: 1px solid #777;
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .textarea-lista {
            width: 100%;
            height: 120px;
            box-sizing: border-box;
            border: 1px solid #777;
            padding: 5px;
            resize: none;
            font-family: monospace;
            font-size: 13px;
        }

        .status-text {
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
            font-size: 13px;
        }

        /* BOTONES */
        .btn-azul {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 13px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .btn-azul:disabled { background-color: #999; cursor: not-allowed; }
        
        .btn-gris-oscuro {
            background-color: #555;
            color: white;
            font-weight: bold;
            border: none;
            padding: 6px;
            cursor: pointer;
            font-size: 11px;
            width: 100%;
            border-radius: 3px;
        }
        .btn-gris-oscuro:hover { background-color: #333; }

        .btn-rojo {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            border-radius: 4px;
        }

        /* VISOR DE ANIMACIÓN */
        .visor-animacion {
            border: 2px solid #007bff;
            background-color: #fff;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #28a745;
            width: 180px;
            align-self: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* --- COLUMNA 2: RESULTADOS VILLA --- */
        .columna-villa {
            width: 140px;
            border: 2px solid #000;
            min-height: 480px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .titulo-lista { font-weight: bold; margin: 10px 0; text-align: center; }
        
        #lista-villa {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        #lista-villa li {
            padding: 5px 10px;
            border-bottom: 1px dashed #ccc;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }
        .hora-villa { font-weight: bold; color: #555; }
        .num-villa { font-weight: bold; color: #000; }

        /* --- COLUMNA 3: TABLA RUTA D --- */
        .columna-tabla {
            width: 240px;
            border: 3px solid #000;
            background: #fff;
            max-height: 800px; 
            overflow-y: auto;
        }
        .header-tabla {
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #000;
            padding: 5px;
            background: #fff;
            position: sticky;
            top: 0;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        td {
            border: 1px solid #000;
            padding: 2px 4px;
            text-align: center;
            height: 22px;
            font-weight: bold;
        }
        
        .txt-azul { color: #0056b3; font-weight: bold; }
        .txt-rojo { color: #d90000; font-weight: bold; }
        
        .celda-normal { background-color: #fff; color: #000; }
        
        /* ESTADO BLOQUEADO (Verde) */
        .celda-bloqueada { 
            background-color: #00b050; 
            color: transparent; 
        }

        /* --- COLUMNA 4: SORTEO PRINCIPAL --- */
        .columna-derecha {
            width: 240px;
        }
        .panel-derecho {
            height: 480px;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <h2>Programa de Sorteo (Bloqueo Dinámico por Cantidad)</h2>

    <div class="contenedor-maestro">

        <div class="columna-control">
            <div class="panel-gris">
                <div class="label-input">CANTIDAD a sortear (VILLA):</div>
                <input type="number" id="input-limite" value="5" min="1">
                
                <textarea id="lista-izq" class="textarea-lista">E 45
E 56
E 33
E 11
E 21
E 60
E 70
E 80
E 90
E 100
E 110
E 120</textarea>
                
                <div id="status-izq" class="status-text">LISTO: 5 a VILLA</div>
                
                <button id="btn-iniciar" class="btn-azul" onclick="iniciarSecuenciaCompleta()">SORTEAR 1 (VILLA)</button>
                <button id="btn-reset" class="btn-rojo" onclick="resetearTodo()">RESETEAR / RESTAURAR</button>
            </div>

            <div class="visor-animacion" id="visor-izq"></div>
            
            <div class="panel-config">
                <div style="text-align: center; font-weight: bold; font-size: 12px; margin-bottom: 5px;">CONFIG. HORARIO SALIDA</div>
                <div style="display: flex; gap: 5px;">
                    <div style="flex: 1;">
                        <div class="label-small">INICIO:</div>
                        <input type="time" id="input-hora-inicio" class="input-config" value="05:48">
                    </div>
                    <div style="flex: 1;">
                        <div class="label-small">INTERVALO (min):</div>
                        <input type="number" id="input-minutos" class="input-config" value="14" min="1">
                    </div>
                </div>
                <button class="btn-gris-oscuro" onclick="generarNuevoHorarioVilla()">APLICAR</button>
                <div id="msg-horario" style="font-size: 10px; color: green; text-align: center; height: 12px;"></div>
            </div>

        </div>

        <div class="columna-villa">
            <div class="titulo-lista">VILLA</div>
            <ul id="lista-villa"></ul>
        </div>

        <div class="columna-tabla">
            <div class="header-tabla">RUTA D</div>
            <table id="tabla-rutad">
                <tbody id="body-tabla">
                    </tbody>
            </table>
        </div>

        <div class="columna-derecha">
            <div class="panel-gris panel-derecho">
                <div>
                    <div class="label-input">SORTEO PRINCIPAL (RUTA D)</div>
                    <textarea id="lista-der" class="textarea-lista" style="height: 220px;" placeholder="Excedentes aquí..."></textarea>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <div id="status-der" class="status-text" style="font-size: 12px;">EN ESPERA...</div>
                    <div class="visor-animacion" id="visor-der" style="width: 100%;"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DEFINICIÓN DEL HORARIO MAESTRO (Inicialmente sin bloqueos fijos) ---
        // 'lock' se calculará dinámicamente según la cantidad ingresada.
        // Se asume que el bloqueo inicia a las 7:25 (según tus indicaciones previas)
        const HORARIO_BASE = [
            {t:'VILLA', h:'5:25'}, {t:'D', h:'5:35'},
            {t:'VILLA', h:'5:45'}, {t:'D', h:'5:55'},
            {t:'VILLA', h:'6:05'}, {t:'D', h:'6:15'},
            {t:'VILLA', h:'6:25'}, {t:'D', h:'6:35'},
            {t:'VILLA', h:'6:45'}, {t:'D', h:'6:55'},
            {t:'VILLA', h:'7:05'}, {t:'D', h:'7:15'},
            // A PARTIR DE AQUI SE APLICA EL BLOQUEO DINAMICO
            {t:'VILLA', h:'7:25'}, {t:'D', h:'7:35'},
            {t:'VILLA', h:'7:45'}, {t:'D', h:'7:55'},
            {t:'VILLA', h:'8:05'}, {t:'D', h:'8:15'},
            {t:'VILLA', h:'8:25'}, {t:'D', h:'8:35'},
            {t:'VILLA', h:'8:45'}, {t:'D', h:'8:55'},
            {t:'VILLA', h:'9:05'}, {t:'D', h:'9:15'},
            {t:'VILLA', h:'9:25'}, {t:'D', h:'9:35'},
            {t:'VILLA', h:'9:45'}, {t:'D', h:'9:55'},
            {t:'VILLA', h:'10:05'},{t:'D', h:'10:15'},
            {t:'VILLA', h:'10:25'},{t:'D', h:'10:35'}
        ];
        
        // Copia de trabajo
        let horarioEstado = JSON.parse(JSON.stringify(HORARIO_BASE));

        // Horas para la lista VILLA (Izquierda) - Por defecto
        let horasVillaActuales = [
            "5:48", "6:02", "6:16", "6:30", "6:44",
            "7:00", "7:14", "7:28", "7:42", "7:56",
            "8:10", "8:24", "8:38", "8:52", "9:06"
        ];

        // --- REFERENCIAS DOM ---
        const listaIzq = document.getElementById('lista-izq');
        const listaDer = document.getElementById('lista-der');
        const ulVilla = document.getElementById('lista-villa');
        const bodyTabla = document.getElementById('body-tabla');
        const btnIniciar = document.getElementById('btn-iniciar');
        const btnReset = document.getElementById('btn-reset');
        const visorIzq = document.getElementById('visor-izq');
        const visorDer = document.getElementById('visor-der');
        const statusIzq = document.getElementById('status-izq');
        const statusDer = document.getElementById('status-der');
        const inputLimite = document.getElementById('input-limite');
        const inputHoraInicio = document.getElementById('input-hora-inicio');
        const inputMinutos = document.getElementById('input-minutos');
        const msgHorario = document.getElementById('msg-horario');

        // Variables de estado
        let indexTabla = 0;
        let indexVilla = 0;
        let backupListaIzq = "";
        let backupListaDer = "";
        let enCurso = false;

        // --- 2. GENERAR TABLA VISUAL ---
        function initTabla() {
            let html = '';
            horarioEstado.forEach((item, i) => {
                const claseTexto = item.t === 'VILLA' ? 'txt-azul' : 'txt-rojo';
                // Si item.lock es true, usamos clase bloqueada (verde)
                const claseCelda = item.lock ? 'celda-bloqueada' : 'celda-normal';
                
                html += `<tr>
                    <td class="${claseTexto}">${item.t}</td>
                    <td class="${claseTexto}">${item.h}</td>
                    <td id="celda-${i}" class="${claseCelda}"></td>
                </tr>`;
            });
            bodyTabla.innerHTML = html;
        }
        
        // Inicializar tabla limpia (sin bloqueos aún o por defecto)
        initTabla();

        // --- 3. LÓGICA DE BLOQUEO DINÁMICO ---
        function aplicarBloqueosPorCantidad() {
            const cantidad = parseInt(inputLimite.value) || 0;
            
            // Reiniciamos estado base
            horarioEstado = JSON.parse(JSON.stringify(HORARIO_BASE));
            
            // Buscar índice de inicio del bloqueo (7:25)
            // Se asume que el bloqueo siempre empieza en la primera VILLA después de 7:15
            // En nuestra lista base es el índice 12 (7:25)
            let startIndex = -1;
            for(let i=0; i<horarioEstado.length; i++) {
                if (horarioEstado[i].h === '7:25' && horarioEstado[i].t === 'VILLA') {
                    startIndex = i;
                    break;
                }
            }

            if (startIndex !== -1 && cantidad > 0) {
                let bloqueadosCount = 0;
                // Recorremos desde 7:25 hacia adelante
                for (let i = startIndex; i < horarioEstado.length; i++) {
                    // Solo bloqueamos si es turno VILLA y aún no alcanzamos la cantidad
                    if (horarioEstado[i].t === 'VILLA') {
                        if (bloqueadosCount < cantidad) {
                            horarioEstado[i].lock = true; // MARCAR COMO VERDE
                            bloqueadosCount++;
                        } else {
                            // Ya cumplimos la cuota, los siguientes VILLA quedan desbloqueados (false por defecto)
                        }
                    }
                }
            }
            
            // Redibujar la tabla inmediatamente para que el usuario vea los cambios
            initTabla();
        }

        // --- 4. CONFIGURACIÓN HORARIO VILLA (Izquierda) ---
        function generarNuevoHorarioVilla() {
            const inicioStr = inputHoraInicio.value; 
            const intervalo = parseInt(inputMinutos.value);

            if (!inicioStr || isNaN(intervalo)) {
                alert("Hora o intervalo inválidos.");
                return;
            }

            const [horas, minutos] = inicioStr.split(':').map(Number);
            let fechaBase = new Date();
            fechaBase.setHours(horas, minutos, 0, 0);

            let nuevasHoras = [];
            for (let i = 0; i < 30; i++) {
                let h = fechaBase.getHours().toString();
                // Formato simple 5:XX en lugar de 05:XX si es menor a 10
                // (Opcional, pero coincide con tu estilo)
                if (fechaBase.getHours() < 10) h = h; 
                else h = h.padStart(2, '0');

                let m = fechaBase.getMinutes().toString().padStart(2, '0');
                nuevasHoras.push(`${h}:${m}`);
                fechaBase.setMinutes(fechaBase.getMinutes() + intervalo);
            }

            horasVillaActuales = nuevasHoras;
            msgHorario.textContent = "¡Horario actualizado!";
            setTimeout(() => msgHorario.textContent = "", 2000);
        }

        // --- 5. RESETEO ---
        function resetearTodo() {
            if (enCurso) {
                if(!confirm("¿Reiniciar todo?")) return;
                location.reload(); 
                return;
            }

            if (backupListaIzq) listaIzq.value = backupListaIzq;
            if (backupListaDer) listaDer.value = backupListaDer;

            ulVilla.innerHTML = '';
            visorIzq.textContent = "";
            visorDer.textContent = "";
            indexTabla = 0;
            indexVilla = 0;

            // Limpiar bloqueos visuales reseteando la tabla
            aplicarBloqueosPorCantidad(); // Se aplica según el input actual

            statusIzq.textContent = "LISTO (RESETEADO)";
            statusDer.textContent = "EN ESPERA...";
            btnIniciar.disabled = false;
        }

        // --- 6. SECUENCIA MAESTRA ---
        async function iniciarSecuenciaCompleta() {
            const raw = listaIzq.value.trim().split('\n').filter(x => x.trim() !== '');
            const limite = parseInt(inputLimite.value) || 5;
            if (raw.length === 0) { alert("Lista vacía"); return; }

            // 1. APLICAR BLOQUEOS ANTES DE EMPEZAR (Visualmente)
            aplicarBloqueosPorCantidad();

            backupListaIzq = listaIzq.value;
            backupListaDer = listaDer.value;

            enCurso = true;
            btnIniciar.disabled = true;
            btnReset.disabled = true;

            // --- FASE 1: SORTEO VILLA ---
            let bolsaJuego = [...raw];
            let ganadores = [];
            ulVilla.innerHTML = '';
            indexVilla = 0;

            for (let i = 0; i < limite; i++) {
                if (bolsaJuego.length === 0) break;
                statusIzq.textContent = `Sorteando ${i+1}/${limite}...`;
                
                const ganador = await animarVisor(visorIzq, bolsaJuego);
                ganadores.push(ganador);
                
                const li = document.createElement('li');
                const hora = horasVillaActuales[indexVilla] || "---";
                li.innerHTML = `<span class="hora-villa">${hora}</span> <span class="num-villa">${ganador}</span>`;
                ulVilla.appendChild(li);
                indexVilla++;
                
                const idx = bolsaJuego.indexOf(ganador);
                if (idx > -1) bolsaJuego.splice(idx, 1);
            }
            statusIzq.textContent = "¡VILLA FINALIZADO!";
            
            // Transferencia
            let textoPrevio = listaDer.value.trim();
            let nuevos = bolsaJuego.join('\n');
            if (textoPrevio !== "") listaDer.value = textoPrevio + "\n" + nuevos;
            else listaDer.value = nuevos;
            
            listaIzq.value = ganadores.join('\n');

            // --- FASE 2: RUTA D (AUTOMÁTICO) ---
            statusDer.textContent = "Iniciando RUTA D...";
            await new Promise(r => setTimeout(r, 1000));

            let bolsaPrincipal = listaDer.value.trim().split('\n').filter(x => x.trim() !== '');
            
            if (bolsaPrincipal.length > 0) {
                // Usamos horarioEstado que ya tiene los locks aplicados
                while (bolsaPrincipal.length > 0 && indexTabla < horarioEstado.length) {
                    
                    // SI LA CELDA ESTÁ BLOQUEADA (lock == true), LA SALTAMOS
                    if (horarioEstado[indexTabla].lock === true) {
                        indexTabla++;
                        continue; 
                    }

                    const ganadorD = await animarVisor(visorDer, bolsaPrincipal);

                    const celda = document.getElementById(`celda-${indexTabla}`);
                    if (celda) celda.textContent = ganadorD;
                    indexTabla++; 

                    const idxD = bolsaPrincipal.indexOf(ganadorD);
                    if (idxD > -1) bolsaPrincipal.splice(idxD, 1);
                    listaDer.value = bolsaPrincipal.join('\n');
                }
                
                if (bolsaPrincipal.length > 0) statusDer.textContent = "Tabla llena (sobran números)";
                else statusDer.textContent = "¡FINALIZADO!";
            } else {
                statusDer.textContent = "No hay excedentes.";
            }

            enCurso = false;
            btnReset.disabled = false;
        }

        // --- ANIMACIÓN ---
        function animarVisor(visor, lista) {
            return new Promise(resolve => {
                let contador = 0;
                const vueltas = 12; // Un poco más rápido
                const intervalo = 40; 
                const timer = setInterval(() => {
                    const random = lista[Math.floor(Math.random() * lista.length)];
                    visor.textContent = random;
                    contador++;
                    if (contador >= vueltas) {
                        clearInterval(timer);
                        const final = lista[Math.floor(Math.random() * lista.length)];
                        visor.textContent = final;
                        resolve(final);
                    }
                }, intervalo);
            });
        }
    </script>
</body>
</html>