<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteo VILLA y RUTA D - Control Total</title>
    <style>
        /* --- ESTILOS VISUALES (Estructura de 4 Columnas) --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 20px;
            color: #000;
        }

        h2 { margin-top: 0; margin-bottom: 20px; }

        .contenedor-maestro {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
        }

        /* --- COLUMNA 1: INPUT VILLA --- */
        .columna-control {
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-gris {
            background-color: #dcdcdc; /* Gris clásico */
            border: 2px solid #000;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .label-input { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        
        #input-limite {
            width: 50px;
            padding: 4px;
            border: 1px solid #777;
            text-align: center;
            margin-bottom: 8px;
        }

        .textarea-lista {
            width: 100%;
            height: 150px;
            box-sizing: border-box;
            border: 1px solid #777;
            padding: 5px;
            resize: none;
            font-family: monospace;
            font-size: 13px;
        }

        .status-text {
            color: #dc3545; /* Rojo */
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
        }

        .btn-azul {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            border-radius: 4px;
        }
        .btn-azul:disabled { background-color: #999; cursor: not-allowed; }
        .btn-azul:hover:not(:disabled) { background-color: #0056b3; }

        /* VISOR E34 */
        .visor-e34 {
            border: 2px solid #007bff;
            background-color: #fff;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #28a745; /* Verde */
            width: 180px;
            align-self: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* --- COLUMNA 2: RESULTADOS VILLA (CON HORAS) --- */
        .columna-villa {
            width: 140px; /* Un poco más ancha para la hora */
            border: 2px solid #000;
            min-height: 480px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .titulo-lista { font-weight: bold; margin: 10px 0; text-align: center; }
        
        #lista-villa {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }
        #lista-villa li {
            padding: 5px 10px;
            border-bottom: 1px dashed #ccc;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }
        .hora-villa { font-weight: bold; color: #555; }
        .num-villa { font-weight: bold; color: #000; }

        /* --- COLUMNA 3: TABLA RUTA D --- */
        .columna-tabla {
            width: 220px;
            border: 3px solid #000;
            background: #fff;
        }
        .header-tabla {
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #000;
            padding: 5px;
            background: #fff;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td {
            border: 1px solid #333;
            padding: 3px;
            text-align: center;
            height: 20px;
            font-weight: bold;
        }
        /* Colores Tabla */
        .txt-azul { color: #007bff; }
        .txt-rojo { color: #cc0000; }
        .celda-ganador { background-color: #fff; color: #000; font-weight: normal; }
        .celda-llena { background-color: #fff3cd; } /* Opcional: Resaltar al llenar */

        /* --- COLUMNA 4: SORTEO PRINCIPAL (EDITABLE) --- */
        .columna-derecha {
            width: 240px;
        }
        /* Panel derecho más alto para acomodar todo */
        .panel-derecho {
            height: 480px;
            justify-content: space-between;
        }

    </style>
</head>
<body>

    <h2>Programa de Sorteo (Input Editable y Rutas Intercaladas)</h2>

    <div class="contenedor-maestro">

        <div class="columna-control">
            <div class="panel-gris">
                <div class="label-input">CANTIDAD a sortear (VILLA):</div>
                <input type="number" id="input-limite" value="5" min="1">
                
                <textarea id="lista-izq" class="textarea-lista">E 45
E 56
E 33
E 11
E 21
E 60
E 70
E 80
E 90
E 100
E 110
E 120</textarea>
                
                <div id="status-izq" class="status-text">LISTO: 5 a VILLA</div>
                
                <button id="btn-villa" class="btn-azul" onclick="iniciarSorteoVilla()">SORTEAR 1 (VILLA)</button>
            </div>

            <div class="visor-e34" id="visor-izq">E 34</div>
        </div>


        <div class="columna-villa">
            <div class="titulo-lista">VILLA</div>
            <ul id="lista-villa">
                </ul>
        </div>


        <div class="columna-tabla">
            <div class="header-tabla">RUTA D</div>
            <table id="tabla-rutad">
                <tbody id="body-tabla">
                    </tbody>
            </table>
        </div>


        <div class="columna-derecha">
            <div class="panel-gris panel-derecho">
                <div>
                    <div class="label-input">SORTEO PRINCIPAL (RUTA D)</div>
                    <textarea id="lista-der" class="textarea-lista" style="height: 220px;" placeholder="Los excedentes aparecerán aquí automáticamente. Puedes escribir más."></textarea>
                </div>

                <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <div id="status-der" class="status-text" style="font-size: 12px;">ESPERANDO DATOS</div>
                    
                    <div class="visor-e34" id="visor-der" style="width: 100%;">E 34</div>
                    
                    <button id="btn-principal" class="btn-azul" onclick="iniciarSorteoPrincipal()" disabled>SORTEAR PRINCIPAL</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DATOS FIJOS ---
        // Horas específicas para VILLA (Recuperadas del código original)
        const HORAS_VILLA = [
            "5:48", "6:02", "6:16", "6:30", "6:44",
            "7:00", "7:14", "7:28", "7:42", "7:56",
            "8:10", "8:24", "8:38", "8:52", "9:06"
        ];

        // Horario intercalado para RUTA D
        const HORARIO_TABLA = [
            {t:'VILLA', h:'5:25'}, {t:'D', h:'5:35'}, {t:'VILLA', h:'5:45'}, {t:'D', h:'5:55'},
            {t:'VILLA', h:'6:05'}, {t:'D', h:'6:15'}, {t:'VILLA', h:'6:25'}, {t:'D', h:'6:35'},
            {t:'VILLA', h:'6:45'}, {t:'D', h:'6:55'}, {t:'VILLA', h:'7:05'}, {t:'D', h:'7:15'},
            {t:'VILLA', h:'7:25'}, {t:'D', h:'7:35'}, {t:'VILLA', h:'7:45'}, {t:'D', h:'7:55'},
            {t:'VILLA', h:'8:05'}, {t:'D', h:'8:15'}, {t:'VILLA', h:'8:25'}, {t:'D', h:'8:35'},
            {t:'VILLA', h:'8:45'}, {t:'D', h:'8:55'}, {t:'VILLA', h:'9:05'}, {t:'D', h:'9:15'},
            {t:'VILLA', h:'9:25'}, {t:'D', h:'9:35'}, {t:'VILLA', h:'9:45'}, {t:'D', h:'9:55'},
            {t:'VILLA', h:'10:05'}, {t:'D', h:'10:15'}, {t:'VILLA', h:'10:25'}, {t:'D', h:'10:35'}
        ];

        // --- ELEMENTOS DOM ---
        const listaIzq = document.getElementById('lista-izq');
        const listaDer = document.getElementById('lista-der');
        const ulVilla = document.getElementById('lista-villa');
        const bodyTabla = document.getElementById('body-tabla');
        const btnVilla = document.getElementById('btn-villa');
        const btnPrincipal = document.getElementById('btn-principal');
        const visorIzq = document.getElementById('visor-izq');
        const visorDer = document.getElementById('visor-der');
        const statusIzq = document.getElementById('status-izq');
        const statusDer = document.getElementById('status-der');
        const inputLimite = document.getElementById('input-limite');

        // Variables de estado
        let enCurso = false;
        let bolsaPrincipal = [];
        let indexTabla = 0;
        let indexVilla = 0;

        // --- INICIO: PINTAR TABLA VACÍA ---
        function initTabla() {
            let html = '';
            HORARIO_TABLA.forEach((item, i) => {
                const color = item.t === 'VILLA' ? 'txt-azul' : 'txt-rojo';
                html += `<tr>
                    <td class="${color}">${item.t}</td>
                    <td class="${color}">${item.h}</td>
                    <td id="celda-${i}" class="celda-ganador"></td>
                </tr>`;
            });
            bodyTabla.innerHTML = html;
        }
        initTabla();

        // --- FUNCIONES DE SORTEO ---

        // 1. SORTEO VILLA (Izquierda)
        async function iniciarSorteoVilla() {
            if (enCurso) return;
            const raw = listaIzq.value.trim().split('\n').filter(x => x.trim() !== '');
            const limite = parseInt(inputLimite.value) || 5;

            if (raw.length === 0) { alert("Lista vacía"); return; }

            enCurso = true;
            btnVilla.disabled = true;
            btnPrincipal.disabled = true; // Bloqueamos el otro mientras tanto
            
            let bolsaJuego = [...raw];
            let ganadores = [];

            // Limpiar resultados anteriores
            ulVilla.innerHTML = '';
            indexVilla = 0;

            // CICLO DE SORTEO VILLA
            for (let i = 0; i < limite; i++) {
                if (bolsaJuego.length === 0) break;
                
                statusIzq.textContent = `Sorteando ${i+1} de ${limite}...`;
                
                // Animación
                const ganador = await animarVisor(visorIzq, bolsaJuego);
                
                // Guardar y mostrar
                ganadores.push(ganador);
                agregarResultadoVilla(ganador); // Función auxiliar con hora
                
                // Eliminar de la bolsa temporal
                const idx = bolsaJuego.indexOf(ganador);
                if (idx > -1) bolsaJuego.splice(idx, 1);
            }

            // FINALIZAR VILLA
            visorIzq.textContent = "E 34";
            statusIzq.textContent = "¡VILLA FINALIZADO!";
            
            // --- TRANSFERENCIA DE EXCEDENTES (AUTOMÁTICA) ---
            // Ponemos los excedentes en el cuadro derecho
            // OJO: Usamos "value" para que el usuario pueda editarlo después.
            // Si ya había algo escrito manualmente antes en la derecha, decidimos si sobrescribir o añadir.
            // Para "flujo limpio", sobrescribimos o añadimos al final. Aquí: Sobrescribimos con los excedentes.
            if (listaDer.value.trim() !== "") {
                listaDer.value += "\n" + bolsaJuego.join('\n');
            } else {
                listaDer.value = bolsaJuego.join('\n');
            }

            // Actualizamos la lista visual izquierda para mostrar solo ganadores (limpieza)
            listaIzq.value = ganadores.join('\n');

            enCurso = false;
            
            // Habilitar el segundo botón si hay datos en la derecha
            if (listaDer.value.trim() !== "") {
                btnPrincipal.disabled = false;
                statusDer.textContent = "LISTO: Revisa y Sortea";
            } else {
                statusDer.textContent = "Sin datos";
            }
        }

        // Auxiliar: Pinta hora y numero en lista Villa
        function agregarResultadoVilla(numero) {
            const li = document.createElement('li');
            const hora = HORAS_VILLA[indexVilla] || "---";
            li.innerHTML = `<span class="hora-villa">${hora}</span> <span class="num-villa">${numero}</span>`;
            ulVilla.appendChild(li);
            indexVilla++;
        }


        // 2. SORTEO PRINCIPAL (Derecha)
        async function iniciarSorteoPrincipal() {
            if (enCurso) return;
            
            // Leemos el textarea por si el usuario editó o añadió números
            const raw = listaDer.value.trim().split('\n').filter(x => x.trim() !== '');
            if (raw.length === 0) { alert("No hay números para sortear."); return; }

            enCurso = true;
            btnPrincipal.disabled = true;
            btnVilla.disabled = true;

            bolsaPrincipal = [...raw]; // Copia para jugar

            // CICLO DE LLENADO DE TABLA
            // Sorteamos hasta vaciar la bolsa o llenar la tabla
            while (bolsaPrincipal.length > 0 && indexTabla < HORARIO_TABLA.length) {
                // Animación
                const ganador = await animarVisor(visorDer, bolsaPrincipal);

                // Pintar en tabla
                const celda = document.getElementById(`celda-${indexTabla}`);
                if (celda) {
                    celda.textContent = ganador;
                    celda.classList.add('celda-llena');
                }
                indexTabla++;

                // Eliminar de bolsa
                const idx = bolsaPrincipal.indexOf(ganador);
                if (idx > -1) bolsaPrincipal.splice(idx, 1);

                // Actualizar textarea (efecto visual de que se consumen)
                listaDer.value = bolsaPrincipal.join('\n');
            }

            visorDer.textContent = "E 34";
            enCurso = false;

            if (bolsaPrincipal.length > 0) {
                statusDer.textContent = "¡Tabla llena! Sobran números.";
                btnPrincipal.disabled = false; // Permitir seguir si se limpiara la tabla o lógica extra
            } else {
                statusDer.textContent = "¡FINALIZADO!";
                btnPrincipal.disabled = true; // Ya no hay nada que sortear
            }
            
            // Habilitar el de Villa por si quieren reiniciar todo manualmente (opcional)
            // btnVilla.disabled = false; 
        }


        // --- UTILIDAD: ANIMACIÓN ---
        function animarVisor(visor, lista) {
            return new Promise(resolve => {
                let contador = 0;
                const totalVueltas = 15;
                const intervaloTiempo = 50; // Rapidez

                const timer = setInterval(() => {
                    const random = lista[Math.floor(Math.random() * lista.length)];
                    visor.textContent = random;
                    // Color verde siempre
                    visor.style.color = '#28a745';
                    
                    contador++;
                    if (contador >= totalVueltas) {
                        clearInterval(timer);
                        // Ganador final real
                        const final = lista[Math.floor(Math.random() * lista.length)];
                        visor.textContent = final;
                        resolve(final);
                    }
                }, intervaloTiempo);
            });
        }

    </script>
</body>
</html>